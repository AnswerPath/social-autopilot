# ADR-0001: Use Node.js Runtime for Twitter API Routes

## Status
Accepted

## Date
2025-08-06

## Context
The Social Autopilot application requires full integration with the Twitter/X API v2 to provide comprehensive social media automation features. During initial development, we implemented API routes using Next.js Edge Runtime for its performance benefits. However, we encountered significant limitations when attempting to implement OAuth 1.0a authentication required for write operations (posting, replying, media uploads) and detailed analytics.

### Requirements
- Full Twitter API v2 access (read and write operations)
- OAuth 1.0a authentication support for user context
- Ability to post tweets, replies, and media
- Access to detailed analytics and metrics
- Reliable credential management with encryption
- Compatibility with `twitter-api-v2` npm package

### Edge Runtime Limitations Discovered
1. **OAuth 1.0a Signature Generation**: The cryptographic operations required for OAuth 1.0a signatures are not available in Edge Runtime's limited Web API surface
2. **Package Compatibility**: The `twitter-api-v2` package relies on Node.js-specific APIs not available in Edge Runtime
3. **Bearer Token Only**: Edge Runtime limits us to Bearer token authentication, which only supports read-only operations
4. **Complex Workarounds**: Implementing OAuth 1.0a in Edge Runtime would require extensive custom implementations and edge-case handling

## Decision
We will use **Node.js runtime** for all Twitter API routes in the application. This is achieved by removing the `export const runtime = 'edge'` declaration from API routes, allowing them to default to Node.js runtime.

### Affected Routes
- `/api/twitter/profile`
- `/api/twitter/tweets`
- `/api/twitter/mentions`
- `/api/twitter/post`
- `/api/twitter/reply`
- `/api/twitter/upload`

## Consequences

### Positive
1. **Full API Access**: Complete Twitter API v2 functionality including OAuth 1.0a authentication
2. **Package Compatibility**: Direct use of `twitter-api-v2` and other Node.js packages without modifications
3. **Industry Standard**: Aligns with common practices for social media automation tools
4. **Simpler Implementation**: No workarounds needed for basic Twitter operations
5. **Future Proof**: All current and future Twitter API features will be supported
6. **Better Documentation**: More examples and community support available

### Negative
1. **Cold Start Performance**: Slightly slower cold starts compared to Edge Runtime (100-200ms difference)
2. **Resource Usage**: Higher memory footprint per function invocation
3. **Scaling Costs**: Potentially higher costs at extreme scale due to longer execution times

### Neutral
1. **Deployment**: No changes to deployment process - Vercel supports both runtimes seamlessly
2. **Development**: Local development experience remains the same

## Implementation Notes

### Migration Steps
1. Remove `export const runtime = 'edge'` from all Twitter API routes
2. Update `lib/twitter-api.ts` to use full `twitter-api-v2` capabilities
3. Fix function calls from `getStoredCredentials()` to `getTwitterCredentials(userId)`
4. Implement proper error handling for OAuth operations

### Performance Optimization
To mitigate the cold start impact:
- Implement response caching where appropriate
- Use ISR (Incremental Static Regeneration) for dashboard data
- Consider implementing a queue system for non-urgent operations

## Alternatives Considered

### 1. Keep Edge Runtime with Workarounds
- **Pros**: Faster cold starts, lower resource usage
- **Cons**: Limited to read-only operations, complex OAuth workarounds, maintenance burden
- **Rejected because**: Core functionality (posting, analytics) would be severely limited

### 2. Hybrid Approach (Mixed Runtimes)
- **Pros**: Optimize each route individually
- **Cons**: Complex codebase, duplicate implementations, harder to maintain
- **Rejected because**: Added complexity outweighs marginal performance benefits

### 3. External OAuth Service
- **Pros**: Edge Runtime compatible, centralized auth
- **Cons**: Additional service dependency, latency, complexity, cost
- **Rejected because**: Introduces unnecessary architectural complexity for a solved problem

## References
- [Next.js Edge Runtime Documentation](https://nextjs.org/docs/app/api-reference/edge)
- [Twitter API v2 Authentication](https://developer.twitter.com/en/docs/authentication/oauth-1-0a)
- [Vercel Edge Runtime Limitations](https://vercel.com/docs/functions/edge-functions/edge-runtime)
- [twitter-api-v2 Package Documentation](https://github.com/PLhery/node-twitter-api-v2)